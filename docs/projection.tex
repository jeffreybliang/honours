\documentclass{article}
\input{commands}
\usepackage{amsmath, amssymb}

\newcommand{\x}{\mathbf{x}}
\title{Mathematical Formulation of Projection Problem}
\author{Jeffrey Liang}
\setlength{\parskip}{\baselineskip}%
\DeclareMathOperator*{\argmax}{argmax}
\DeclareMathOperator*{\argmin}{argmin}

\begin{document}
\maketitle

\section{Goal}
To project a set of points $\mathcal X$ onto the nearest ellipsoid with volume 1, such that the projection of this ellipsoid in two different views produces ellipses which minimise the error between their areas and two target areas.

\section{Parametrising Ellipsoids}

An ellipsoid $\mathcal E$ can be parametrised by a positive definite, symmetric matrix $A \in \R^{3\times 3}$ as follows:
\begin{equation}
    \mathcal E = \lrbrace{\x \in \R^3 | \x^\top A \x = 1, A \succ 0}.
\end{equation}
By performing an eigen-decomposition on $A$, we have that $A$ can be represented as $\mathbf A= \mathbf Q^\top \mathbf  \Lambda \mathbf  Q$, where $\mathbf Q\in SO(3)$ is an orthonormal rotation matrix and $\mathbf \Lambda$ is a diagonal matrix with eigenvalues that are the inverse square of the semi-axes lengths of $\mathcal E$:
\begin{align}
    A &= \mathbf Q^\top \mathbf \Lambda \mathbf Q \\
        & = \mathbf Q^\top \begin{bmatrix}
            \lambda_1 & & \\
            & \lambda_2 & \\
            & & \lambda_3
        \end{bmatrix}\mathbf Q \\
        &= \mathbf Q^\top \begin{bmatrix}
            1/a^2 & & \\
            & 1/b^2 & \\
            & & 1/c^2
        \end{bmatrix}\mathbf Q,
\end{align}
where $a, b,$ and $c$ are the semi-axes lengths of the ellipsoid $\mathcal E$. As the rotation matrix can be parametrised by three Euler angles -- roll $\psi$, pitch $\theta$, and yaw $\phi$ -- in addition to the three semi-axes, an ellipsoid in 3D can thus be parametrised by six degrees of freedom which we can represent as a vector $\mathbf u \in \R^6$. 

\section{Inner-Level Problem}
Let $\mathcal{X} = \lrbrace{\mathbf x_i}$ be a set of sampled points $\mathbf x_i \in \R^3$ from a noisy ellipsoid. Moreover, let $Q: \R^3 \to SO(3)$ map three angles (roll, pitch, yaw) to the orthonormal 3D rotation matrix $\mathbf Q$ defined above and $\Lambda: \R^3 \to \R^{3\times 3}$ map three lengths to the diagonal matrix $\mathbf \Lambda$ described above.

To project these points to the nearest ellipsoid with a volume of 1 unit cubed, we can minimise the least squares error subject to the volume constraint.
\begin{equation}
    \begin{array}{ll}
        \underset{\text {over } \mathbf u\in \R^6}{\text{minimize}} & \sum_{i=1}^{m} \left({\mathbf x_i}^\top Q(\mathbf u_{4:6}) ^\top \Lambda(\mathbf u_{1:3}) Q(\mathbf u_{4:6}) \mathbf x_i - 1\right)^2 \\[0.8em]
        \text{subject to} & \frac{4}{3} \pi \mathbf u_1 \mathbf u_2 \mathbf u_3 = 1
      \end{array}          
\end{equation}
Or, in matrix form, letting $$\mathbf X = \begin{bmatrix}
    | & \cdots & | \\
    \mathbf x_1 & \cdots & \mathbf x_m \\
    | & \cdots & |
  \end{bmatrix},$$
  we have

\begin{equation}
    \begin{array}{ll}
        \underset{\text {over } \mathbf u\in \R^6}{\text{minimize}} & \lr\Vert\Vert {\text{diag}(\mathbf X^\top Q(\mathbf u_{4:6}) ^\top \Lambda(\mathbf u_{1:3}) Q(\mathbf u_{4:6}) \mathbf X) - \mathbf 1_m} ^2 \\[0.8em]
        \text{subject to} & \frac{4}{3} \pi \mathbf u_1 \mathbf u_2 \mathbf u_3 = 1
      \end{array}          
\end{equation}

\section{Outer-Level Problem}
There are two approaches to performing the projection of the ellipsoid into two different views: parametrically and via point-sampling.

\subsection{Parametric Approach}
To perform the projection using parameters obtained from the inner-level problem, we employ orthographic projections. We simulate orthographic projections into two different views by rotating the projected ellipse produced from the inner-level problem differently for each view before projecting the rotated ellipsoids both onto the $x$-$y$ plane.

Two views were chosen as we believed this was sufficient to constrain the problem such that the ellipsoid matched the desired properties.

The output of the inner-level problem gives us a vector 
$$
\begin{array}{ll}
    \mathbf u^* = &\argmin \lr\Vert\Vert {\text{diag}(\mathbf X^\top Q(\mathbf u_{4:6}) ^\top \Lambda(\mathbf u_{1:3}) Q(\mathbf u_{4:6}) \mathbf X) - \mathbf 1_m} ^2 \\[0.5em] &\text{subject to} \frac{4}{3} \pi \mathbf u_1 \mathbf u_2 \mathbf u_3 = 1.
\end{array}          
$$

Using this $\mathbf u^*$, we have the projected ellipsoid with volume 1, and can apply the rotation matrices to the resulting $A(\mathbf u^*) = Q(\mathbf u_{4:6}) ^\top \Lambda(\mathbf u_{1:3}) Q(\mathbf u_{4:6})$. The rotations are performed by two rotation matrices, $\mathbf R_1, \mathbf R_2 \in SO(3)$ respectively. Each are applied as a right conjugation to the matrix $A(\mathbf u^*)$ in a change-of-basis operation.

Thus, we get two rotated ellipsoids, $\mathcal E_1$ and $\mathcal E_2$, parametrised by the following corresponding matrices:
\begin{align}
    \mathcal E_1: \mathbf{R}_1^\top A(\mathbf u^*) \mathbf{R}_1 \qquad \mathcal E_2: \mathbf{R}_2^\top A(\mathbf u^*) \mathbf{R}_2.
\end{align}

To apply the projection onto the $x$-$y$ plane, it is \textit{not} as simple as multiplying the projection matrix $\mathbf P$,
\begin{equation}
    \mathbf P = \begin{bmatrix}
        1 & 0 & 0\\
        0 & 1 & 0
    \end{bmatrix},
\end{equation}
as this will give us the cross-section with the $x$-$y$ plane instead. To obtain the projection, we need to take the Schur complement of the bottom-right entry of the 3D matrix. Let $S: \R^{3\times 3} \to \R^{2\times 2}$ return the Schur complement described above. Then, the two 2D ellipses $\varepsilon_1$ and $\varepsilon_2$ whose areas we are interested in are parametrised by the matrices $\hat{\mathbf A}_1$ and $\hat{\mathbf A}_2$:
\begin{align}
    \varepsilon_1:\hat{\mathbf A}_1= S\lr(){ \mathbf{R}_1^\top A(\mathbf u^*) \mathbf{R}_1} \qquad \varepsilon_2: \hat{\mathbf A}_2 = S\lr() {\mathbf{R}_2^\top A(\mathbf u^*) \mathbf{R}_2}.
\end{align}
The determinants of these $2\times 2$ matrices  $\hat{\mathbf A}_1$ and $\hat{\mathbf A}_2$ would give the product of the eigenvalues of each matrix. As the eigenvalues would be the squared inverses of the semi-axes of $\varepsilon_1$ and $\varepsilon_2$, the inverse square root of the product of eigenvalues gives the product of the semi-axes lengths. Therefore, the area of an ellipse can be expressed as:
\begin{equation}
    \pi ab = \frac{\pi }{\frac{1}{\sqrt{a^2b^2}}}= \frac{\pi }{\sqrt{\lambda _1 \lambda _2}} = \frac{\pi}{\sqrt{\det{\hat{\mathbf A}_i}}}.
\end{equation}

Given two target areas $t_1$ and $t_2$ for the projected ellipses $\varepsilon_1$ and $\varepsilon_2$, our final minimisation problem is thus:
$$
\begin{array}{ll}
    \underset{\text{over} \mathcal X = \{ \mathbf x_i \}}{\text{minimize}} &  \lr\Vert\Vert { \frac{\pi}{\sqrt{\det \hat{A}_1(\mathbf u^*)}} - t_1} ^2 + \lr\Vert\Vert{ \frac{\pi}{\sqrt{\det \hat{A}_2(\mathbf u^*)}} - t_2} ^2  \\[0.5em]
  \text{subject to} & \mathbf u^* = \text{argmin} \; \lr\Vert\Vert {\text{diag}(\mathbf X^\top Q(\mathbf u_{4:6}) ^\top \Lambda(\mathbf u_{1:3}) Q(\mathbf u_{4:6}) \mathbf X) - \mathbf 1_m} ^2 \\[0.5em]
  & \hphantom{y =} \text{subject to} \;  \frac{4}{3} \pi \mathbf u_1 \mathbf u_2 \mathbf u_3 = 1
\end{array}.
$$

\subsection{Sampling Approach}
A point-sampling-based approach is more involved, though is more relevant to the water balloon example which this toy example will graduate to.

After obtaining the projected ellipsoid with unit volume, 

\end{document}